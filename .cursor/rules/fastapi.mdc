---
description: FastAPI 框架规范，适用于后端 API 开发
globs: **/app/**/*.py
alwaysApply: false
---

# FastAPI 框架规范

## 项目结构
```
app/
├── main.py           # 应用入口
├── config.py         # 配置管理
├── database.py       # 数据库连接
├── api/
│   ├── __init__.py
│   ├── deps.py       # 依赖注入
│   └── v1/
│       ├── recipes.py
│       └── users.py
├── models/           # SQLAlchemy ORM
├── schemas/          # Pydantic 模型
├── services/         # 业务逻辑
├── repositories/     # 数据访问层
└── utils/            # 工具函数
```

## 路由定义
```python
from fastapi import APIRouter, Depends, HTTPException, status
from app.schemas.recipe import RecipeCreate, RecipeResponse
from app.services.recipe import RecipeService

router = APIRouter(prefix="/recipes", tags=["recipes"])

@router.get("/{recipe_id}", response_model=RecipeResponse)
async def get_recipe(
    recipe_id: int,
    service: RecipeService = Depends()
) -> RecipeResponse:
    recipe = await service.get_by_id(recipe_id)
    if not recipe:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Recipe not found"
        )
    return recipe
```

## Schema 定义
```python
from pydantic import BaseModel, Field
from typing import List, Optional

class RecipeBase(BaseModel):
    title: str = Field(..., min_length=1, max_length=100)
    difficulty: int = Field(..., ge=1, le=5)

class RecipeCreate(RecipeBase):
    ingredients: List[int]

class RecipeResponse(RecipeBase):
    id: int
    
    class Config:
        from_attributes = True
```

## 依赖注入
- 数据库会话通过 `Depends` 注入
- Service 层通过依赖注入获取 Repository
- 认证/权限通过依赖实现

## 错误处理
- 使用 `HTTPException` 返回错误
- 自定义异常处理器统一格式
- 返回结构化错误响应

## 数据库操作
- 使用 SQLAlchemy 2.0 异步语法
- Repository 模式封装 CRUD
- 事务在 Service 层管理

## API 版本控制
- URL 前缀：`/api/v1/`
- 向后兼容原则
- 废弃 API 使用 `Deprecated` 头

## 配置管理
```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    database_url: str
    openai_api_key: str
    
    class Config:
        env_file = ".env"

settings = Settings()
```
